
<p>Discovery Education Standards Code Sample</p>
<p>The below code contruct was responsible show showing standards and for the backend flow of processing a new Trial. All security sensitive information has been hidden</p>
<div id="de-standards-code">
    <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020">&lt;cfcomponent</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #996633">extends</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;base&quot;</span> <span style="color: #996633">accessors</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setCourseService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;courseService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.courseService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.courseService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getCourseService&quot;</span>  <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.courseService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setStandardsService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;standardsService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.standardsService</span> <span style="color: #333333">=</span> <span style="color: #996633">argumentts.standardsService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getStandardsService&quot;</span>  <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.standardsService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setTaxonomyService&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;taxonomyService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.taxonomyService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.taxonomyService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getTaxonomyService&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.taxonomyService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;before&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.serviceUsageRights&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">super.before</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">isAuthenticated</span>()<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.statusCode</span> <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">403</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfthrow</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.DE_AUTHENTICATION_EXCEPTION_TYPE#&quot;</span> <span style="color: #996633">message</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;Forbidden&quot;</span> <span style="color: #996633">detail</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;Access to this page requires authentication.&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">hasServiceUsageRights</span>(<span style="color: #996633">serviceUsageRights</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.serviceUsageRights</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfthrow</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.DE_FORBIDDEN_EXCEPTION_TYPE#&quot;</span> <span style="color: #996633">message</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;The request requires the correct service usage rights&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;list&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.returnRoot&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.grade&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.countryRegionStruct</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCourseService</span>().<span style="color: #0066BB; font-weight: bold">findCountryRegionCode</span>(<span style="color: #996633">courseGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.courseGuid</span>
                ,<span style="color: #996633">regionCode</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getRegionCode</span>()
                ,<span style="color: #996633">countryCode</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getCountryCode</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #888888">&lt;!--- TODO : legacy format for region code, update this when we update the gateway ---&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.countryRegionCode</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">listAppend</span>(<span style="color: #996633">local.countryRegionStruct.countryCode</span>, <span style="color: #996633">local.countryRegionStruct.regionCode</span>, <span style="background-color: #fff0f0">&quot;|&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.standards</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getStandardsService</span>().<span style="color: #0066BB; font-weight: bold">findTechbookNodes</span>(<span style="color: #996633">courseGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.courseGuid</span>
                ,<span style="color: #996633">regionCode</span><span style="color: #333333">=</span><span style="color: #996633">local.countryRegionCode</span>
                ,<span style="color: #996633">grade</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.grade</span>
                ,<span style="color: #996633">returnTopLevel</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.returnRoot</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #888888">&lt;!--- children query includes parents query ---&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.result.data</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.returnRoot</span> <span style="color: #FF0000; background-color: #FFAAAA">?</span> <span style="color: #996633">local.standards.parentsQuery</span> : <span style="color: #996633">local.standards.childrenQuery</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;children&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.grade&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.countryRegionStruct</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCourseService</span>().<span style="color: #0066BB; font-weight: bold">findCountryRegionCode</span>(<span style="color: #996633">courseGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.courseGuid</span>
                ,<span style="color: #996633">regionCode</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getRegionCode</span>()
                ,<span style="color: #996633">countryCode</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getCountryCode</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #888888">&lt;!--- TODO : legacy format for region code, update this when we update the gateway ---&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.countryRegionCode</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">listAppend</span>(<span style="color: #996633">local.countryRegionStruct.countryCode</span>, <span style="color: #996633">local.countryRegionStruct.regionCode</span>, <span style="background-color: #fff0f0">&quot;|&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.result.data</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getStandardsService</span>().<span style="color: #0066BB; font-weight: bold">findStandardChildren</span>(<span style="color: #996633">guid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.standardGuid</span>
                ,<span style="color: #996633">courseGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.courseGuid</span>
                ,<span style="color: #996633">countryRegion</span><span style="color: #333333">=</span><span style="color: #996633">local.countryRegionCode</span>
                ,<span style="color: #996633">grade</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.grade</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;taxonomies&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.thumbnailTypeIds&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.SEARCH_THUMBNAIL_ID#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.levelOneTaxonomyQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getTaxonomyService</span>().<span style="color: #0066BB; font-weight: bold">findTopLevelTaxonomy</span>(<span style="color: #996633">serviceUsageRights</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.serviceUsageRights</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.levelOneTaxonomiesGuidList</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">valueList</span>(<span style="color: #996633">local.levelOneTaxonomyQuery.guidTaxId</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.result.data</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getTaxonomyService</span>().<span style="color: #0066BB; font-weight: bold">findTaxonomiesBy</span>(<span style="color: #996633">assetGuidList</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.standardGuid</span>
                ,<span style="color: #996633">thumbnailTypeIds</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.thumbnailTypeIds</span>
                ,<span style="color: #996633">levelOneTaxonomyIdList</span><span style="color: #333333">=</span><span style="color: #996633">local.levelOneTaxonomiesGuidList</span>
                ,<span style="color: #996633">relationshipTypeIdList</span><span style="color: #333333">=</span><span style="color: #996633">variables.ASSET_TAXONOMY_RELATIONSHIP_GUID</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;tree&quot;</span> <span style="color: #996633">returnType</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span>
            <span style="color: #996633">hint</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;returns a tree structure for each standards in the guid list passed&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.level&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;5&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.countryCode&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#getSecurityService().getCountryCode()#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.regionCode&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#getSecurityService().getRegionCode()#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #888888">&lt;!--- if courseGuid is passed as a filter, we will need to filter by country code and region code ---&gt;</span>
            <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">structKeyExists</span>(<span style="color: #996633">arguments.rc</span>, <span style="background-color: #fff0f0">&quot;courseGuid&quot;</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.countryRegionStruct</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCourseService</span>().<span style="color: #0066BB; font-weight: bold">findCountryRegionCode</span>(<span style="color: #996633">courseGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.courseGuid</span>
                    ,<span style="color: #996633">regionCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.regionCode</span>
                    ,<span style="color: #996633">countryCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.countryCode</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.countryCode</span> <span style="color: #333333">=</span> <span style="color: #996633">local.countryRegionStruct.countryCode</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.regionCode</span> <span style="color: #333333">=</span> <span style="color: #996633">local.countryRegionStruct.regionCode</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.criteria</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUtility</span>().<span style="color: #0066BB; font-weight: bold">mapFunctionArguments</span>(<span style="color: #996633">inputMethod</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getStandardsService</span>().<span style="color: #0066BB; font-weight: bold">getTarget</span>().<span style="color: #996633">findTechbookStandardTree</span>
                ,<span style="color: #996633">inputStruct</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.result</span>[<span style="background-color: #fff0f0">&quot;data&quot;</span>] <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getStandardsService</span>().<span style="color: #0066BB; font-weight: bold">findTechbookStandardTree</span>(<span style="color: #996633">argumentCollection</span><span style="color: #333333">=</span><span style="color: #996633">local.criteria</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

    <span style="color: #007020">&lt;/cfcomponent&gt;</span>
    </pre></div>
</div>

Discovery Education Campaign Code Sample
<div id="de-campaign-code">
    <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #007020">&lt;cfcomponent</span> <span style="color: #996633">extends</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;base&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
        <span style="color: #888888">&lt;!--- constants ---&gt;</span>
        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.USER_TITLES_CODE</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;USERTITLES&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.LEAD_SOURCE_CODE</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;LEADSOURCE&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.LEAD_SOURCE.VIRTUAL</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;V&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.LEAD_SOURCE.IN_PERSON</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;I&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.LEAD_SOURCE.PAID</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;P&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.CAMPAIGN_DEMO_SITE_GUID</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;20000000-0000-3785-5e75-000000000000&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #888888">&lt;!--- dependencies ---&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setCampaignService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;campaignService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.campaignService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.campaignService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getCampaignService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.campaignService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setProductService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;productService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.productService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.productService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getProductService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.productService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setRoleService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;roleService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.roleService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.roleService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getRoleService&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.roleService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setSecurityService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;securityService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.securityService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.securityService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getSecurityService&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.securityService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setSessionService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;sessionService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.sessionService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.sessionService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getSessionService&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.sessionService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setSiteService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;siteService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.siteService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.siteService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getSiteService&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.siteService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setUserService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;userService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.userService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.userService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getUserService&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.userService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;setUserSettingService&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;userSettingService&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;any&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">variables.userSettingService</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.userSettingService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;getUserSettingService&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">variables.userSettingService</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #888888">&lt;!--- public methods ---&gt;</span>
        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;signup&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.next&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.fw.buildUrl(&quot;core:me.view&quot;)#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.freePasscode</span> <span style="color: #333333">=</span> <span style="color: #996633">variables.FREE_USER_PASSCODE</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.showExtraInfo</span> <span style="color: #333333">=</span> <span style="color: #996633">true</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">variables.fw.request</span>() <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&quot;POST&quot;</span><span style="color: #007020">&gt;</span>
                <span style="color: #888888">&lt;!--- first check to see if this is a passCode ---&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSiteService</span>().<span style="color: #0066BB; font-weight: bold">validatePassCode</span>(<span style="color: #996633">passCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">local.validationResult.valid</span><span style="color: #007020">&gt;</span>
                    <span style="color: #888888">&lt;!--- if not a passCode, maybe this is a campaign code? ---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">validateCampaignCode</span>(<span style="color: #996633">campaignCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">local.validationResult.valid</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="color: #996633">variables.INVALID_CODE_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfelse&gt;</span>
                        <span style="color: #888888">&lt;!--- this is a campaign code AND the campaign is still applicable ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;campaign&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.siteGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.campaignQuery.defaultSiteGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.roleGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.campaignQuery.defaultRoleGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.identifyuser&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>
                <span style="color: #007020">&lt;cfelse&gt;</span>
                    <span style="color: #888888">&lt;!--- this is a passCode ---&gt;</span>
                    <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.registrationCode</span> <span style="color: #996633">NEQ</span> <span style="color: #996633">arguments.rc.freePasscode</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.showExtraInfo</span> <span style="color: #333333">=</span> <span style="color: #996633">false</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>

                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;passCode&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.siteName</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.siteInfo.name</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.siteGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.siteInfo.siteGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.roleGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.siteInfo.roleGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.newuser&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;forgot&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #008800; font-weight: bold">var</span> <span style="color: #996633">local</span> <span style="color: #333333">=</span> {} <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.isValidUser</span> <span style="color: #333333">=</span> <span style="color: #996633">false</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.usernameEmail&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.alert&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #0066BB; font-weight: bold">Trim</span>(<span style="color: #996633">arguments.rc.alert</span>))<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">arrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="color: #996633">arguments.rc.alert</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfreturn</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">cgi.request_method</span> <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&quot;POST&quot;</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #0066BB; font-weight: bold">Trim</span>(<span style="color: #996633">arguments.rc.usernameEmail</span>))<span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">arrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="color: #996633">variables.NO_RECORD_FOUND_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfreturn</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>

                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.userQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.userService.findUsersBy</span>( <span style="color: #996633">username</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">trim</span>(<span style="color: #996633">arguments.rc.usernameEmail</span>) ) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">local.userQuery.recordCount</span> <span style="color: #333333">EQ</span> <span style="color: #6600EE; font-weight: bold">1</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span>(<span style="color: #008800; font-weight: bold">LEN</span>(<span style="color: #0066BB; font-weight: bold">Trim</span>(<span style="color: #996633">local.userQuery.email</span>)))<span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.NO_EMAIL_FOR_USERNAME_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfelse&gt;</span>
                        <span style="color: #888888">&lt;!--- if we get exactly 1 record, create a reset token and email it ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.isValidUser</span> <span style="color: #333333">=</span> <span style="color: #996633">true</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>
                <span style="color: #007020">&lt;cfelseif</span> <span style="color: #996633">local.userQuery.recordCount</span> <span style="color: #333333">GT</span> <span style="color: #6600EE; font-weight: bold">1</span><span style="color: #007020">&gt;</span>
                    <span style="color: #888888">&lt;!--- oops, we don&#39;t have unique constraint on uid, doh! ---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.DUPLICATE_USERNAME_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfelse&gt;</span>
                    <span style="color: #888888">&lt;!--- check the email address ---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.userQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.userService.findUsersBy</span>( <span style="color: #996633">email</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">trim</span>(<span style="color: #996633">arguments.rc.usernameEmail</span>) ) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">local.userQuery.recordCount</span> <span style="color: #333333">EQ</span> <span style="color: #6600EE; font-weight: bold">1</span><span style="color: #007020">&gt;</span>
                        <span style="color: #888888">&lt;!--- if we get exactly 1 record, create a reset token and email it ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.isValidUser</span> <span style="color: #333333">=</span> <span style="color: #996633">true</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfelseif</span> <span style="color: #996633">local.userQuery.recordCount</span> <span style="color: #333333">GT</span> <span style="color: #6600EE; font-weight: bold">1</span><span style="color: #007020">&gt;</span>
                        <span style="color: #888888">&lt;!--- we don&#39;t have unique constraint on email ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.DUPLICATE_EMAIL_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfelse&gt;</span>
                        <span style="color: #888888">&lt;!--- if we got here, we didn&#39;t find any records ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.NO_RECORD_FOUND_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">local.isValidUser</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.userRoleQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.roleService.findUsersRoles</span>( <span style="color: #996633">userGuidList</span> <span style="color: #333333">=</span> <span style="color: #996633">local.userQuery.app_user_guid</span> ) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">local.userRoleQuery.recordCount</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.userRoleList</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">valueList</span>(<span style="color: #996633">local.userRoleQuery.roleGuid</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">listFindNoCase</span>(<span style="color: #0066BB; font-weight: bold">Ucase</span>(<span style="color: #996633">local.userRoleList</span>), <span style="color: #996633">variables.STUDENT_ROLE_GUID</span>)<span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.STUDENT_NOT_AUTHORIZED_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfreturn</span>  <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>
                <span style="color: #007020">&lt;cfelse&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.NO_ROLE_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfreturn</span>  <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">FindNoCase</span>(<span style="color: #0066BB; font-weight: bold">Right</span>(<span style="color: #996633">local.userQuery.uid</span>,<span style="color: #6600EE; font-weight: bold">22</span>),<span style="color: #0066BB; font-weight: bold">getConfig</span>().<span style="color: #996633">domainName</span>) <span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.SSO_USERS_NOT_AUTHORIZED_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfreturn</span>  <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.userGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.userQuery.app_user_guid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.firstName</span> <span style="color: #333333">=</span> <span style="color: #996633">local.userQuery.first_name</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.lastName</span> <span style="color: #333333">=</span> <span style="color: #996633">local.userQuery.last_name</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.username</span> <span style="color: #333333">=</span> <span style="color: #996633">local.userQuery.uid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.email</span> <span style="color: #333333">=</span> <span style="color: #996633">local.userQuery.email</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.token</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.userService.generateResetToken</span>(<span style="color: #996633">arguments.rc.userGuid</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #888888">&lt;!---</span>
    <span style="color: #888888">                we cannot render the view template, so we&#39;ll just pass control and call the service from the view</span>
    <span style="color: #888888">                in FW/1 2.0, this can be done, e.g. emailBody = fw.view(&quot;templates/resetpassword&quot;)</span>
    <span style="color: #888888">            ---&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;templates.resetpassword&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;resetPassword&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #008800; font-weight: bold">var</span> <span style="color: #996633">success</span> <span style="color: #333333">=</span> <span style="color: #996633">false</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #008800; font-weight: bold">var</span> <span style="color: #996633">local</span> <span style="color: #333333">=</span> {} <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #008800; font-weight: bold">var</span> <span style="color: #996633">result</span> <span style="color: #333333">=</span> {} <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.token&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;string&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.newPassword&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;string&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.confirmPassword&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;string&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.userGuid&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.userService.findUserByToken(arguments.rc.token)#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.userGuid</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.userService.findUserByToken</span>(<span style="color: #996633">arguments.rc.token</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">IsValid</span>(<span style="background-color: #fff0f0">&quot;guid&quot;</span>, <span style="color: #996633">arguments.rc.userGuid</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.redirect</span>(<span style="color: #996633">action</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;main.forgot&quot;</span>, <span style="color: #996633">queryString</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&amp;?alert=Invalid reset token.&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfelse&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #0066BB; font-weight: bold">Trim</span>(<span style="color: #996633">arguments.rc.newPassword</span>))<span style="color: #007020">&gt;</span>
                    <span style="color: #888888">&lt;!--- validate ---&gt;</span>
                    <span style="color: #007020">&lt;cfif</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.newPassword</span>) <span style="color: #333333">LT</span> <span style="color: #6600EE; font-weight: bold">5</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.PASSWORD_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>

                    <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.newPassword</span> <span style="color: #996633">NEQ</span> <span style="color: #996633">arguments.rc.confirmPassword</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.CONFIRM_PASSWORD_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>

                    <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">arguments.rc.errors</span>)<span style="color: #007020">&gt;</span>
                        <span style="color: #888888">&lt;!--- save the updated password ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">result</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.userService.savePassword</span>( <span style="color: #996633">userGuidList</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.userGuid</span>, <span style="color: #996633">password</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.newPassword</span> ) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                        <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">result.valid</span><span style="color: #007020">&gt;</span>
                            <span style="color: #888888">&lt;!--- delete the reset token ---&gt;</span>
                            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.userService.deleteResetToken</span>( <span style="color: #996633">arguments.rc.token</span> ) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                            <span style="color: #888888">&lt;!--- authenticate user ---&gt;</span>
                            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.loginResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.securityService.login</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.userGuid</span>
                                ,<span style="color: #996633">userAgent</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.userAgent</span>
                                ,<span style="color: #996633">ipAddress</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findRemoteAddress</span>()
                                ,<span style="color: #996633">source</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;resetPassword&quot;</span>
                                ,<span style="color: #996633">referrer</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findReferrer</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.redirect</span>(<span style="color: #996633">url</span><span style="color: #333333">=</span><span style="color: #996633">local.loginResult.nextUrl</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfelse&gt;</span>
                            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>,<span style="color: #996633">variables.PASSWORD_UPDATE_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;/cfif&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;ldapSignUp&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationPassCodeResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSiteService</span>().<span style="color: #0066BB; font-weight: bold">validatePassCode</span>(<span style="color: #996633">passCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.passCode</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">local.validationPassCodeResult.valid</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="background-color: #fff0f0">&quot;Please select your school.&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfelse&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;LDAP&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationUserInfoResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">validateSignUp</span>(<span style="color: #996633">argumentCollection</span><span style="color: #333333">=</span><span style="color: #996633">arguments</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationUserInfoResult.errors</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">arguments.rc.errors</span>)<span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.userGuid</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUserService</span>().<span style="color: #0066BB; font-weight: bold">saveUser</span>(<span style="color: #996633">firstName</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.firstName</span>
                        ,<span style="color: #996633">lastName</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.lastName</span>
                        ,<span style="color: #996633">email</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.email</span>
                        ,<span style="color: #996633">username</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.username</span>
                        ,<span style="color: #996633">siteGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.validationPassCodeResult.siteInfo.siteGuid</span>
                        ,<span style="color: #996633">roleGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.validationPassCodeResult.siteInfo.roleGuid</span>
                        ,<span style="color: #996633">organization</span><span style="color: #333333">=</span><span style="color: #996633">local.validationPassCodeResult.siteInfo.name</span>
                        ,<span style="color: #996633">isPasswordRequired</span><span style="color: #333333">=</span><span style="color: #996633">false</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">isValid</span>(<span style="background-color: #fff0f0">&quot;guid&quot;</span>, <span style="color: #996633">local.userGuid</span>)<span style="color: #007020">&gt;</span>
                        <span style="color: #888888">&lt;!--- authenticate user ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.loginResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">login</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>
                            ,<span style="color: #996633">userAgent</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.userAgent</span>
                            ,<span style="color: #996633">ipAddress</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findRemoteAddress</span>()
                            ,<span style="color: #996633">source</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;ldapRegistration&quot;</span>
                            ,<span style="color: #996633">referrer</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findReferrer</span>()
                            ,<span style="color: #996633">nextUrl</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;/&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.redirect</span>(<span style="color: #996633">url</span><span style="color: #333333">=</span><span style="color: #996633">local.loginResult.nextURL</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfelse&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">arrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="background-color: #fff0f0">&quot;Error creating user account.&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #888888">&lt;!---reset the form w/ original info if there were any errors ---&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.sites</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSiteService</span>().<span style="color: #0066BB; font-weight: bold">findSitesBy</span>(<span style="color: #996633">accountGuidList</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.accountGuid</span>, <span style="color: #996633">returnPassCodes</span><span style="color: #333333">=</span><span style="color: #996633">true</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.sites</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUtility</span>().<span style="color: #0066BB; font-weight: bold">filterQuery</span>(<span style="color: #996633">query</span><span style="color: #333333">=</span><span style="color: #996633">local.sites</span>, <span style="color: #996633">column</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;roleguid&quot;</span>, <span style="color: #996633">values</span><span style="color: #333333">=</span><span style="color: #996633">variables.TEACHER_ROLE_GUID</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;LDAP&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.showExtraInfo</span> <span style="color: #333333">=</span> <span style="color: #996633">false</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.signUpAction</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.fw.buildUrl</span>(<span style="background-color: #fff0f0">&#39;public:main.ldapSignUp&#39;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs</span> <span style="color: #333333">=</span> {} <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.username</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.username</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.accountGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.accountGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.newuser&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;signUpNewUserInfo&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.userTitle&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #888888">&lt;!--- This is a hack because we don&#39;t know the site we need to set a user to until after we log them in ---&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSiteService</span>().<span style="color: #0066BB; font-weight: bold">validatePassCode</span>(<span style="color: #996633">passCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">local.validationResult.valid</span><span style="color: #007020">&gt;</span>
                <span style="color: #888888">&lt;!--- if not a passCode, maybe this is a campaign code? ---&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">validateCampaignCode</span>(<span style="color: #996633">campaignCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">local.validationResult.valid</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="color: #996633">variables.INVALID_CODE_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfelse&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.siteGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.campaignQuery.defaultSiteGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.roleGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.campaignQuery.defaultRoleGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;cfelse&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.roleGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.siteInfo.roleGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.siteGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.siteInfo.siteGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">arguments.rc.errors</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">validateSignUp</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.errors</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">arguments.rc.errors</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.userGuid</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUserService</span>().<span style="color: #0066BB; font-weight: bold">saveUser</span>(<span style="color: #996633">firstName</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.firstName</span>
                    ,<span style="color: #996633">lastName</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.lastName</span>
                    ,<span style="color: #996633">email</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.email</span>
                    ,<span style="color: #996633">password</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.password</span>
                    ,<span style="color: #996633">username</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.username</span>
                    ,<span style="color: #996633">siteGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&quot;campaign&quot;</span> <span style="color: #FF0000; background-color: #FFAAAA">?</span> <span style="color: #996633">variables.FREE_USER_SITE_GUID</span> : <span style="color: #996633">local.siteGuid</span>
                    ,<span style="color: #996633">roleGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.roleGuid</span>
                    ,<span style="color: #996633">title</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.userTitle</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">IsValid</span>(<span style="background-color: #fff0f0">&quot;guid&quot;</span>, <span style="color: #996633">local.userGuid</span>)<span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.registrationCode</span> <span style="color: #333333">EQ</span> <span style="color: #996633">variables.FREE_USER_PASSCODE</span> <span style="color: #333333">OR</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&quot;campaign&quot;</span><span style="color: #007020">&gt;</span>
                        <span style="color: #888888">&lt;!--- save MDR data ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.mdrResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUserSettingService</span>().<span style="color: #0066BB; font-weight: bold">saveUserMdrData</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>
                            ,<span style="color: #996633">pid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.pid</span>
                            ,<span style="color: #996633">schoolName</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolName</span>
                            ,<span style="color: #996633">schoolAddress</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolAddress</span>
                            ,<span style="color: #996633">schoolCity</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolCity</span>
                            ,<span style="color: #996633">schoolCountry</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolCountry</span>
                            ,<span style="color: #996633">schoolState</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolState</span>
                            ,<span style="color: #996633">schoolZip</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolZip</span>
                            ,<span style="color: #996633">userSettings</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getUserSettings</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>

                    <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #996633">NEQ</span> <span style="background-color: #fff0f0">&quot;campaign&quot;</span><span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.redirect</span>(<span style="color: #996633">url</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.next</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfelse&gt;</span>
                        <span style="color: #888888">&lt;!--- GAiello - 02-05-2014 - only save LeadSource for campaign users as &#39;P&#39; ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.isSuccess</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUserSettingService</span>().<span style="color: #0066BB; font-weight: bold">saveUserSetting</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>
                            ,<span style="color: #996633">code</span><span style="color: #333333">=</span><span style="color: #996633">variables.LEAD_SOURCE_CODE</span>
                            ,<span style="color: #996633">value</span><span style="color: #333333">=</span><span style="color: #996633">variables.LEAD_SOURCE.PAID</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                        <span style="color: #888888">&lt;!--- Saves the answers to the campaign questions. ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">registerCampaignQuestions</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>, <span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                        <span style="color: #888888">&lt;!--- GAiello - use the country and region the user picked from MDR, to make certain they get the proper sub campaign products ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.subCampaignQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">findSubCampaignsBy</span>(<span style="color: #996633">parentCampaign</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>
                            ,<span style="color: #996633">regionCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolState</span>
                            ,<span style="color: #996633">countryCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolCountry</span>
                            ,<span style="color: #996633">returnProducts</span><span style="color: #333333">=</span><span style="color: #996633">true</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                        <span style="color: #888888">&lt;!--- If they are a new user we know the Site is incorrect we need to reset the user&#39;s site ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">getUserService</span>().<span style="color: #0066BB; font-weight: bold">shuffleUser</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>
                            ,<span style="color: #996633">siteGuid</span><span style="color: #333333">=</span><span style="color: #996633">variables.FREE_USER_SITE_GUID</span>
                            ,<span style="color: #996633">shuffleToSiteGuid</span><span style="color: #333333">=</span> <span style="color: #996633">local.subCampaignQuery.recordCount</span> <span style="color: #FF0000; background-color: #FFAAAA">?</span> <span style="color: #996633">local.subCampaignQuery.defaultSiteGuid</span> : <span style="color: #996633">local.siteGuid</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                         <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.loginResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">login</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>
                            ,<span style="color: #996633">nextURL</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.next</span>
                            ,<span style="color: #996633">userAgent</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.userAgent</span>
                            ,<span style="color: #996633">ipAddress</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findRemoteAddress</span>()
                            ,<span style="color: #996633">source</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;campaign&quot;</span>
                            ,<span style="color: #996633">referrer</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findReferrer</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                        <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">local.subCampaignQuery.recordCount</span><span style="color: #007020">&gt;</span>
                            <span style="color: #888888">&lt;!--- Assume the role is incorrectly set and set it to the default role of the subcampaign ---&gt;</span>
                            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">getRoleService</span>().<span style="color: #0066BB; font-weight: bold">removeUserRole</span>(<span style="color: #996633">userGuidList</span><span style="color: #333333">=</span><span style="color: #996633">local.userGUid</span>, <span style="color: #996633">userRoleGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.roleGuid</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">getRoleService</span>().<span style="color: #0066BB; font-weight: bold">addUserRole</span>(<span style="color: #996633">userGuidList</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>, <span style="color: #996633">userRoleGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.subCampaignQuery.defaultRoleGuid</span>)<span style="color: #007020">&gt;</span>
                        <span style="color: #007020">&lt;/cfif&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>
                <span style="color: #007020">&lt;cfelse&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="background-color: #fff0f0">&quot;Error creating user account.&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.showExtraInfo</span> <span style="color: #333333">=</span> (<span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&quot;campaign&quot;</span> <span style="color: #333333">OR</span> <span style="color: #996633">arguments.rc.registrationCode</span> <span style="color: #333333">EQ</span> <span style="color: #996633">variables.FREE_USER_PASSCODE</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.newuser&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&quot;campaign&quot;</span> <span style="color: #333333">AND</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">arguments.rc.errors</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">campaignProductSelection</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>, <span style="color: #996633">isNewUser</span><span style="color: #333333">=</span><span style="color: #996633">true</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfelse&gt;</span>
                <span style="color: #888888">&lt;!---if you get this far then there must have been an error; reset view/try again---&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.newuser&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;buildCampaignParams&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;campaign&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.showExtraInfo</span> <span style="color: #333333">=</span> <span style="color: #996633">true</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.campaignQuestionQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">findCampaignQuestionsBy</span>(<span style="color: #996633">campaignCodeList</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>
                ,<span style="color: #996633">placement</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;newuser&quot;</span>
                ,<span style="color: #996633">returnAnswers</span><span style="color: #333333">=</span><span style="color: #996633">true</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.questionMap</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUtility</span>().<span style="color: #0066BB; font-weight: bold">mapQuery</span>(<span style="color: #996633">query</span><span style="color: #333333">=</span><span style="color: #996633">local.campaignQuestionQuery</span>, <span style="color: #996633">callback</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getUtility</span>().<span style="color: #996633">formatAsArrays</span>, <span style="color: #996633">key</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;questionGuid&quot;</span>, <span style="color: #996633">group</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;questionType&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.newuser&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;signupExistingCampaignUser&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.isNewuser</span> <span style="color: #333333">=</span> <span style="color: #996633">false</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">structKeyExists</span>(<span style="color: #996633">arguments.rc</span>,<span style="background-color: #fff0f0">&quot;username&quot;</span>) <span style="color: #333333">AND</span>
                (<span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #0066BB; font-weight: bold">Trim</span>(<span style="color: #996633">arguments.rc.username</span>)) <span style="color: #333333">AND</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #0066BB; font-weight: bold">Trim</span>(<span style="color: #996633">arguments.rc.password</span>)))<span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.loginResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.securityService.login</span>(<span style="color: #996633">username</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.username</span>
                    ,<span style="color: #996633">password</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.password</span>
                    ,<span style="color: #996633">ipAddress</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findRemoteAddress</span>()
                    ,<span style="color: #996633">referrer</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findReferrer</span>()
                    ,<span style="color: #996633">source</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;username&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">structKeyExists</span>(<span style="color: #996633">local.loginResult</span>, <span style="background-color: #fff0f0">&quot;userGuid&quot;</span>)<span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.user</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getCurrentUser</span>() <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">campaignProductSelection</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>, <span style="color: #996633">isNewUser</span><span style="color: #333333">=</span><span style="color: #996633">false</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfelse&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="color: #996633">variables.LOGIN_ERROR_TEXT</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.existingUserError</span> <span style="color: #333333">=</span> <span style="color: #996633">true</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.identifyuser&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;cfelse&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="color: #996633">variables.USERNAME_PASSWORD_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.existingUserError</span> <span style="color: #333333">=</span> <span style="color: #996633">true</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.identifyuser&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;campaignRegisterSelections&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;public&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">structKeyExists</span>(<span style="color: #996633">arguments.rc</span>, <span style="background-color: #fff0f0">&quot;selectedProducts&quot;</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="background-color: #fff0f0">&quot;Please select a product&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfelse&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">arguments.rc.errors</span>)<span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.subCampaignInfoQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">findSubCampaignsBy</span>(<span style="color: #996633">parentCampaign</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>
                        ,<span style="color: #996633">regionCode</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getRegionCode</span>()
                        ,<span style="color: #996633">countryCode</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getCountryCode</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">registerCampaignProductsForUser</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getUserGuid</span>()
                        ,<span style="color: #996633">productGuidList</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.selectedProducts</span>
                        ,<span style="color: #996633">campaignCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>
                        ,<span style="color: #996633">subCampaignCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.subRegistrationCode</span>
                        ,<span style="color: #996633">siteGuid</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getSiteGuid</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #888888">&lt;!--- Insert the questions into the db ---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">registerCampaignQuestions</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>, <span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getUserGuid</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #888888">&lt;!--- GAiello - must bounce user - to pick up new products media packs etc. ---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.userGuid</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getUserGuid</span>() <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.loginResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">login</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>
                        ,<span style="color: #996633">source</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;campaignRelogin&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #888888">&lt;!--- use non-https url so campaign videos play ---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.redirect</span>(<span style="color: #996633">url</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getConfig</span>().<span style="color: #0066BB; font-weight: bold">getUrl</span>(<span style="background-color: #fff0f0">&quot;app&quot;</span>)) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">campaignProductSelection</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>, <span style="color: #996633">isNewUser</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.isNewUser</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;registerCampaignQuestions&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;private&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;userGuid&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;guid&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.textAnswerStruct</span> <span style="color: #333333">=</span> {<span style="color: #996633">questionGuids</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">arrayNew</span>(<span style="color: #6600EE; font-weight: bold">1</span>), <span style="color: #996633">responses</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">arrayNew</span>(<span style="color: #6600EE; font-weight: bold">1</span>)} <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfloop</span> <span style="color: #996633">collection</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#arguments.rc#&quot;</span> <span style="color: #996633">item</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;local.submitted&quot;</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">isValid</span>(<span style="background-color: #fff0f0">&quot;guid&quot;</span>, <span style="color: #996633">local.submitted</span>) <span style="color: #333333">AND</span> <span style="color: #008800; font-weight: bold">len</span>(<span style="color: #0066BB; font-weight: bold">trim</span>(<span style="color: #996633">arguments.rc</span>[<span style="color: #996633">local.submitted</span>])) <span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.textAnswerStruct.questionGuids</span>, <span style="color: #996633">local.submitted</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.textAnswerStruct.responses</span>, <span style="color: #996633">arguments.rc</span>[<span style="color: #996633">local.submitted</span>]) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfloop&gt;</span>
            <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">local.textAnswerStruct.questionGuids</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">createCampaignResponses</span>(<span style="color: #996633">campaignCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>
                    ,<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.userGuid</span>
                    ,<span style="color: #996633">responses</span><span style="color: #333333">=</span><span style="color: #996633">local.textAnswerStruct.responses</span>
                    ,<span style="color: #996633">questionGuidList</span><span style="color: #333333">=</span><span style="color: #996633">local.textAnswerStruct.questionGuids</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">structKeyExists</span>(<span style="color: #996633">arguments.rc</span>, <span style="background-color: #fff0f0">&quot;selectedAnswers&quot;</span>) <span style="color: #333333">AND</span> <span style="color: #008800; font-weight: bold">len</span>(<span style="color: #0066BB; font-weight: bold">trim</span>(<span style="color: #996633">arguments.rc.selectedAnswers</span>))<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">createCampaignSelectedResponses</span>(<span style="color: #996633">campaignCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>
                    ,<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.userGuid</span>
                    ,<span style="color: #996633">answerGuidList</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.selectedAnswers</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;campaignProductSelection&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;private&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;isNewUser&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;boolean&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">validateCampaignCode</span>(<span style="color: #996633">campaignCode</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.registrationCode</span>
                ,<span style="color: #996633">countryCode</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getCountryCode</span>()
                ,<span style="color: #996633">regionCode</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getRegionCode</span>()
                ,<span style="color: #996633">returnProducts</span><span style="color: #333333">=</span><span style="color: #996633">true</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">local.validationResult.valid</span><span style="color: #007020">&gt;</span>
                <span style="color: #888888">&lt;!--- log user back out ---&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">logout</span>() <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="background-color: #fff0f0">&quot;This Campaign Code is Invalid&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.signup&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfelse&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.campaignProductsQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">determineCampaignProducts</span>(<span style="color: #996633">campaignProductQuery</span><span style="color: #333333">=</span><span style="color: #996633">local.validationResult.campaignQuery</span>, <span style="color: #996633">isNewUser</span><span style="color: #333333">=</span><span style="color: #996633">arguments.isNewUser</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.productQuery</span> <span style="color: #333333">=</span> <span style="color: #996633">local.campaignProductsQuery</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.campaignQuestionMap</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">determineCampaignQuestions</span>(<span style="color: #996633">campaignProductQuery</span><span style="color: #333333">=</span><span style="color: #996633">local.validationResult.campaignQuery</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.questionMap</span> <span style="color: #333333">=</span> <span style="color: #996633">local.campaignQuestionMap</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #888888">&lt;!---after filtering out invalid products, make sure there are still valid products left to display and if not kick them out with an error message---&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.productQuery.recordCount</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs</span> <span style="color: #333333">=</span> {} <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.registrationCode</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.campaignQuery.campaignCode</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.canSelectProducts</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.campaignQuery.canSelectProducts</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #888888">&lt;!---we are assuming that there is only 1 child campaign code---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.subRegistrationCode</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.campaignQuery.subCampaignCode</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.isNewUser</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.isNewUser</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.campaignchooseproducts&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfelse&gt;</span>
                    <span style="color: #888888">&lt;!--- log user back out ---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">logout</span>() <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">buildNewSignUpParams</span>(<span style="color: #996633">rc</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="background-color: #fff0f0">&quot;You have already used all of the products associated with this campaign code&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.setView</span>(<span style="background-color: #fff0f0">&quot;public:main.signup&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;determineCampaignProducts&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;private&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;query&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #996633">hint</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;compares the products to the users products&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;campaignProductQuery&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;query&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;isNewUser&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;boolean&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">arguments.isNewUser</span> <span style="color: #333333">AND</span> <span style="color: #996633">arguments.campaignProductQuery.hasLockout</span><span style="color: #007020">&gt;</span>
                <span style="color: #888888">&lt;!---find user&#39;s products---&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.usedProductsQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">findUsedCampaignProducts</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getUserGuid</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.usedProductGuids</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">ValueList</span>(<span style="color: #996633">local.usedProductsQuery.productGuid</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.campaignProductQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUtility</span>().<span style="color: #0066BB; font-weight: bold">filterQuery</span>(<span style="color: #996633">query</span><span style="color: #333333">=</span><span style="color: #996633">arguments.campaignProductQuery</span>
                    ,<span style="color: #996633">values</span><span style="color: #333333">=</span><span style="color: #996633">local.usedProductGuids</span>
                    ,<span style="color: #996633">column</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;productSKUGuid&quot;</span>
                    ,<span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;cf_sql_idstamp&quot;</span>
                    ,<span style="color: #996633">exclude</span><span style="color: #333333">=</span><span style="color: #996633">true</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">arguments.campaignProductQuery</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;determineCampaignQuestions&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;private&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;campaignProductQuery&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;query&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.campaignCodeList</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">ListAppend</span>(<span style="color: #0066BB; font-weight: bold">ValueList</span>(<span style="color: #996633">arguments.campaignProductQuery.subCampaignCode</span>), <span style="color: #996633">arguments.campaignProductQuery.campaignCode</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.campaignCodeList</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUtility</span>().<span style="color: #0066BB; font-weight: bold">removeCommon</span>(<span style="color: #996633">list1</span><span style="color: #333333">=</span><span style="color: #996633">local.campaignCodeList</span>, <span style="color: #996633">list2</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.campaignQuestionQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getCampaignService</span>().<span style="color: #0066BB; font-weight: bold">findCampaignQuestionsBy</span>(<span style="color: #996633">campaignCodeList</span><span style="color: #333333">=</span><span style="color: #996633">local.campaignCodeList</span>, <span style="color: #996633">placement</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;campaignchooseproducts&quot;</span>, <span style="color: #996633">returnAnswers</span><span style="color: #333333">=</span><span style="color: #996633">true</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.questionMap</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUtility</span>().<span style="color: #0066BB; font-weight: bold">mapQuery</span>(<span style="color: #996633">query</span><span style="color: #333333">=</span><span style="color: #996633">local.campaignQuestionQuery</span>, <span style="color: #996633">callback</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getUtility</span>().<span style="color: #996633">formatAsArrays</span>, <span style="color: #996633">key</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;questionGuid&quot;</span>, <span style="color: #996633">group</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;questionType&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">local.questionMap</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;buildNewSignUpParams&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;private&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.newuser&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.firstName&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.lastName&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.email&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.confirmEmail&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.username&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.password&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.confirmPassword&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.schoolName&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.schoolAddress&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.schoolZip&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.schoolCity&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.schoolState&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.schoolCountry&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.states&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.cities&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.existingUserError&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;argumetns.rc.showExtraInfo&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.next&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.fw.buildUrl(&quot;core:me.view&quot;)#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.signUpType&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;passCode&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.registrationCode&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.FREE_USER_PASSCODE#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.siteName&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.siteGuid&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.FREE_USER_SITE_GUID#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.roleGuid&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#variables.TEACHER_ROLE_GUID#&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.canSelectProducts&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.showExtraInfo&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfparam</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;arguments.rc.hiddenInputs&quot;</span> <span style="color: #008800; font-weight: bold">default</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;{}&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs</span> <span style="color: #333333">=</span> {} <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.next</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.next</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.signUpType</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.registrationCode</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.registrationCode</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.roleGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.roleGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.siteGuid</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.siteGuid</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.hiddenInputs.showExtraInfo</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.showExtraInfo</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.freePasscode</span> <span style="color: #333333">=</span> <span style="color: #996633">variables.FREE_USER_PASSCODE</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.userTitlesQuery</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUserSettingService</span>().<span style="color: #0066BB; font-weight: bold">findUserProperties</span>(<span style="color: #996633">codeList</span><span style="color: #333333">=</span><span style="color: #996633">variables.USER_TITLES_CODE</span>, <span style="color: #996633">sortBy</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;displayText&quot;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.domainCountry</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getConfig</span>().<span style="color: #996633">countryCode</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.isCanada</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.domainCountry</span> <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&#39;CA&#39;</span> <span style="color: #FF0000; background-color: #FFAAAA">?</span> <span style="color: #996633">true</span> : <span style="color: #996633">false</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.maxZipCodeLength</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.isCanada</span> <span style="color: #FF0000; background-color: #FFAAAA">?</span> <span style="color: #6600EE; font-weight: bold">7</span> : <span style="color: #6600EE; font-weight: bold">5</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.signUpAction</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.fw.buildUrl</span>(<span style="background-color: #fff0f0">&#39;public:main.signUpNewUserInfo&#39;</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;validateSignUp&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;private&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span>
                <span style="color: #996633">hint</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;validates all signup info based upon signup type (ldap, saml, etc)&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.result</span> <span style="color: #333333">=</span> {} <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.result.errors</span> <span style="color: #333333">=</span> [] <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">structKeyExists</span>(<span style="color: #996633">arguments.rc</span>, <span style="background-color: #fff0f0">&quot;siteGuid&quot;</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">IsValid</span>(<span style="background-color: #fff0f0">&quot;guid&quot;</span>, <span style="color: #996633">arguments.rc.siteGuid</span>)<span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.INVALID_SITE_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">structKeyExists</span>(<span style="color: #996633">arguments.rc</span>, <span style="background-color: #fff0f0">&quot;accountGuid&quot;</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">IsValid</span>(<span style="background-color: #fff0f0">&quot;guid&quot;</span>, <span style="color: #996633">arguments.rc.accountGuid</span>)<span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.ACCOUNT_GUID_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.firstName</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.FIRST_NAME_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.lastName</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.LAST_NAME_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">IsValid</span>(<span style="background-color: #fff0f0">&quot;email&quot;</span>, <span style="color: #996633">arguments.rc.email</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.EMAIL_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.email</span> <span style="color: #996633">NEQ</span> <span style="color: #996633">arguments.rc.confirmEmail</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.CONFIRM_EMAIL_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.username</span>) <span style="color: #333333">LT</span> <span style="color: #6600EE; font-weight: bold">6</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.USERNAME_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #996633">NEQ</span> <span style="background-color: #fff0f0">&quot;LDAP&quot;</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.password</span>) <span style="color: #333333">LT</span> <span style="color: #6600EE; font-weight: bold">5</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.PASSWORD_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.password</span> <span style="color: #996633">NEQ</span> <span style="color: #996633">arguments.rc.confirmPassword</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.CONFIRM_PASSWORD_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.password</span> <span style="color: #333333">=</span> <span style="color: #996633">arguments.rc.confirmPassword</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #888888">&lt;!--- we do not have site information for new campaign or free pass code users by default ---&gt;</span>
            <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&quot;campaign&quot;</span> <span style="color: #333333">OR</span>
                <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">EQ</span> <span style="background-color: #fff0f0">&quot;passCode&quot;</span> <span style="color: #333333">AND</span> <span style="color: #996633">arguments.rc.registrationCode</span> <span style="color: #333333">EQ</span> <span style="color: #996633">variables.FREE_USER_PASSCODE</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.schoolName</span>)
                    <span style="color: #333333">OR</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.schoolAddress</span>)
                    <span style="color: #333333">OR</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.schoolCity</span>)
                    <span style="color: #333333">OR</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.schoolCountry</span>)
                    <span style="color: #333333">OR</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.schoolState</span>)
                    <span style="color: #333333">OR</span> <span style="color: #333333">NOT</span> <span style="color: #008800; font-weight: bold">Len</span>(<span style="color: #996633">arguments.rc.schoolZip</span>)<span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.MDR_SCHOOL_INFO_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">local.result.errors</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.usernameAvailable</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.userService.usernameAvailable</span>(<span style="color: #996633">username</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.username</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">local.usernameAvailable.valid</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">local.usernameAvailable.message</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>

                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.emailAvailable</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">variables.userService.emailAvailable</span>(<span style="color: #996633">arguments.rc.email</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #996633">local.emailAvailable.valid</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">local.emailAvailable.message</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">structKeyExists</span>(<span style="color: #996633">arguments.rc</span>, <span style="background-color: #fff0f0">&quot;agreeTermsOfUse&quot;</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">local.result.errors</span>, <span style="color: #996633">variables.TERMS_ERROR</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

            <span style="color: #007020">&lt;cfreturn</span> <span style="color: #996633">local.result</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
        <span style="color: #007020">&lt;/cffunction&gt;</span>

        <span style="color: #007020">&lt;cffunction</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;passcodeRegistration&quot;</span> <span style="color: #996633">access</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;private&quot;</span> <span style="color: #996633">returntype</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;void&quot;</span> <span style="color: #996633">output</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfargument</span> <span style="color: #996633">name</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;rc&quot;</span> <span style="color: #996633">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;struct&quot;</span> <span style="color: #996633">required</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;true&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.signUpType</span> <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;passCodeSignUpPartTwo&quot;</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.validationResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">validateSignUp</span>(<span style="color: #996633">argumentCollection</span><span style="color: #333333">=</span><span style="color: #996633">arguments</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
            <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">arguments.rc.errors</span> <span style="color: #333333">=</span> <span style="color: #996633">local.validationResult.errors</span> <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

            <span style="color: #007020">&lt;cfif</span> <span style="color: #333333">NOT</span> <span style="color: #0066BB; font-weight: bold">ArrayLen</span>(<span style="color: #996633">arguments.rc.errors</span>)<span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.userGuid</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUserService</span>().<span style="color: #0066BB; font-weight: bold">saveUser</span>(<span style="color: #996633">firstName</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.firstName</span>
                    ,<span style="color: #996633">lastName</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.lastName</span>
                    ,<span style="color: #996633">email</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.email</span>
                    ,<span style="color: #996633">password</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.password</span>
                    ,<span style="color: #996633">username</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.username</span>
                    ,<span style="color: #996633">siteGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.siteGuid</span>
                    ,<span style="color: #996633">roleGuid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.roleGuid</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                <span style="color: #007020">&lt;cfif</span> <span style="color: #0066BB; font-weight: bold">IsValid</span>(<span style="background-color: #fff0f0">&quot;guid&quot;</span>, <span style="color: #996633">local.userGuid</span>)<span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;cfif</span> <span style="color: #996633">arguments.rc.passcode</span> <span style="color: #333333">EQ</span> <span style="color: #996633">variables.FREE_USER_PASSCODE</span><span style="color: #007020">&gt;</span>
                        <span style="color: #888888">&lt;!--- save MDR data ---&gt;</span>
                        <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.mdrResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getUserSettingService</span>().<span style="color: #0066BB; font-weight: bold">saveUserMdrData</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>
                            ,<span style="color: #996633">pid</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.pid</span>
                            ,<span style="color: #996633">schoolName</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolName</span>
                            ,<span style="color: #996633">schoolAddress</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolAddress</span>
                            ,<span style="color: #996633">schoolCity</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolCity</span>
                            ,<span style="color: #996633">schoolCountry</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolCountry</span>
                            ,<span style="color: #996633">schoolState</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolState</span>
                            ,<span style="color: #996633">schoolZip</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.schoolZip</span>
                            ,<span style="color: #996633">userSettings</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">getUserSettings</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                    <span style="color: #007020">&lt;/cfif&gt;</span>

                    <span style="color: #888888">&lt;!--- authenticate user ---&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #996633">local.loginResult</span> <span style="color: #333333">=</span> <span style="color: #0066BB; font-weight: bold">getSecurityService</span>().<span style="color: #0066BB; font-weight: bold">login</span>(<span style="color: #996633">userGuid</span><span style="color: #333333">=</span><span style="color: #996633">local.userGuid</span>
                        ,<span style="color: #996633">nextURL</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.next</span>
                        ,<span style="color: #996633">userAgent</span><span style="color: #333333">=</span><span style="color: #996633">arguments.rc.userAgent</span>
                        ,<span style="color: #996633">ipAddress</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findRemoteAddress</span>()
                        ,<span style="color: #996633">source</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;passcodeRegistration&quot;</span>
                        ,<span style="color: #996633">referrer</span><span style="color: #333333">=</span><span style="color: #0066BB; font-weight: bold">variables.fw.findReferrer</span>()) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>

                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">variables.fw.redirect</span>(<span style="color: #996633">url</span><span style="color: #333333">=</span><span style="color: #996633">local.loginResult.nextURL</span>) <span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;cfelse&gt;</span>
                    <span style="color: #007020">&lt;cfset</span> <span style="color: #0066BB; font-weight: bold">ArrayAppend</span>(<span style="color: #996633">arguments.rc.errors</span>, <span style="background-color: #fff0f0">&quot;Error creating user account.&quot;</span>)<span style="color: #333333">/</span><span style="color: #007020">&gt;</span>
                <span style="color: #007020">&lt;/cfif&gt;</span>
            <span style="color: #007020">&lt;/cfif&gt;</span>

        <span style="color: #007020">&lt;/cffunction&gt;</span>

    <span style="color: #007020">&lt;/cfcomponent&gt;</span>
    </pre></div>
</div>